<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context-Aware Scene Detailing Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        
            padding-bottom: 420px; /* Make room for log viewer */}
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        .test-description {
            color: #666;
            margin-bottom: 15px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .result.loading {
            background: #fefce8;
            border: 1px solid #eab308;
            color: #713f12;
        }
        .context-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .scene-chain {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .scene-card {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 10px;
            flex: 1;
            min-width: 200px;
        }
        .scene-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        .scene-objective {
            font-size: 12px;
            color: #64748b;
        }
    </style>
    
    <!-- Visual Log Viewer -->
    <script src="log-viewer.js"></script>

</head>
<body>
    <div class="container">
        <h1>ðŸŽ­ Context-Aware Scene Detailing Test</h1>
        <p>Test the context-aware scene detailing functionality with different scenarios.</p>
    </div>

    <div class="container">
        <div class="test-section">
            <div class="test-title">Test 1: First Scene (No Context)</div>
            <div class="test-description">
                Generate the first scene detail without any previous context. This should work normally.
            </div>
            <button class="test-button" onclick="testFirstScene()">Test First Scene</button>
            <div id="test1-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">Test 2: Context Chain (3 Scenes)</div>
            <div class="test-description">
                Test a complete context chain where each scene builds upon the previous ones.
            </div>
            <div class="scene-chain">
                <div class="scene-card">
                    <div class="scene-title">Scene 1: The Tavern</div>
                    <div class="scene-objective">Meet the mysterious stranger</div>
                </div>
                <div class="scene-card">
                    <div class="scene-title">Scene 2: The Forest</div>
                    <div class="scene-objective">Follow the stranger into the woods</div>
                </div>
                <div class="scene-card">
                    <div class="scene-title">Scene 3: The Clearing</div>
                    <div class="scene-objective">Discover the hidden ritual site</div>
                </div>
            </div>
            <button class="test-button" onclick="testContextChain()">Test Context Chain</button>
            <div id="test2-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">Test 3: NPC Relationship Context</div>
            <div class="test-description">
                Test how NPC relationships and trust levels carry over between scenes.
            </div>
            <button class="test-button" onclick="testNPCRelationships()">Test NPC Relationships</button>
            <div id="test3-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">Test 4: State Changes Context</div>
            <div class="test-description">
                Test how world state changes (like "trust_level_host: -1") affect subsequent scenes.
            </div>
            <button class="test-button" onclick="testStateChanges()">Test State Changes</button>
            <div id="test4-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        async function testFirstScene() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Generating first scene...';

            try {
                const request = {
                    sceneId: 'scene_1_test',
                    macroScene: {
                        id: 'scene_1_test',
                        title: 'The Tavern',
                        objective: 'Meet the mysterious stranger',
                        order: 1
                    },
                    effectiveContext: {
                        keyEvents: [],
                        revealedInfo: [],
                        stateChanges: {},
                        npcRelationships: {},
                        environmentalState: {},
                        plotThreads: [],
                        playerDecisions: []
                    }
                };

                const response = await fetch(`${API_BASE}/generate_detail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testContextChain() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Generating context chain...';

            try {
                // Scene 1
                const scene1 = await generateSceneDetail({
                    sceneId: 'scene_1_chain',
                    macroScene: {
                        id: 'scene_1_chain',
                        title: 'The Tavern',
                        objective: 'Meet the mysterious stranger',
                        order: 1
                    },
                    effectiveContext: createEmptyContext()
                });

                // Scene 2 with context from Scene 1
                const scene2 = await generateSceneDetail({
                    sceneId: 'scene_2_chain',
                    macroScene: {
                        id: 'scene_2_chain',
                        title: 'The Forest',
                        objective: 'Follow the stranger into the woods',
                        order: 2
                    },
                    effectiveContext: scene1.data.contextOut
                });

                // Scene 3 with context from Scene 1 and 2
                const effectiveContext3 = createEffectiveContext([scene1.data, scene2.data]);
                const scene3 = await generateSceneDetail({
                    sceneId: 'scene_3_chain',
                    macroScene: {
                        id: 'scene_3_chain',
                        title: 'The Clearing',
                        objective: 'Discover the hidden ritual site',
                        order: 3
                    },
                    effectiveContext: effectiveContext3
                });

                resultDiv.className = 'result success';
                resultDiv.textContent = `Scene 1 Context Out:\n${JSON.stringify(scene1.data.contextOut, null, 2)}\n\n` +
                                     `Scene 2 Context Out:\n${JSON.stringify(scene2.data.contextOut, null, 2)}\n\n` +
                                     `Scene 3 Context Out:\n${JSON.stringify(scene3.data.contextOut, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testNPCRelationships() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing NPC relationships...';

            try {
                // Scene 1: Meet NPC with neutral relationship
                const scene1 = await generateSceneDetail({
                    sceneId: 'scene_npc_1',
                    macroScene: {
                        id: 'scene_npc_1',
                        title: 'Meeting the Guard',
                        objective: 'Convince the guard to let you pass',
                        order: 1
                    },
                    effectiveContext: createEmptyContext()
                });

                // Modify the context to simulate a negative interaction
                const modifiedContext = {
                    ...scene1.data.contextOut,
                    npcRelationships: {
                        guard: {
                            trust_level: -1,
                            last_interaction: 'players were rude and threatening',
                            attitude: 'hostile'
                        }
                    }
                };

                // Scene 2: Same NPC with modified relationship
                const scene2 = await generateSceneDetail({
                    sceneId: 'scene_npc_2',
                    macroScene: {
                        id: 'scene_npc_2',
                        title: 'The Gate',
                        objective: 'Try to pass through the guarded gate',
                        order: 2
                    },
                    effectiveContext: modifiedContext
                });

                resultDiv.className = 'result success';
                resultDiv.textContent = `Scene 1 NPC Context:\n${JSON.stringify(scene1.data.contextOut.npcRelationships, null, 2)}\n\n` +
                                     `Scene 2 NPC Context:\n${JSON.stringify(scene2.data.contextOut.npcRelationships, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testStateChanges() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing state changes...';

            try {
                // Scene 1: Normal state
                const scene1 = await generateSceneDetail({
                    sceneId: 'scene_state_1',
                    macroScene: {
                        id: 'scene_state_1',
                        title: 'The Village',
                        objective: 'Gather information about the missing merchant',
                        order: 1
                    },
                    effectiveContext: createEmptyContext()
                });

                // Modify context to include state changes
                const modifiedContext = {
                    ...scene1.data.contextOut,
                    stateChanges: {
                        trust_level_host: -1,
                        village_alert_level: 'high',
                        merchant_found: false,
                        villagers_suspicious: true
                    }
                };

                // Scene 2: With state changes
                const scene2 = await generateSceneDetail({
                    sceneId: 'scene_state_2',
                    macroScene: {
                        id: 'scene_state_2',
                        title: 'The Merchant\'s House',
                        objective: 'Search for clues about the merchant\'s disappearance',
                        order: 2
                    },
                    effectiveContext: modifiedContext
                });

                resultDiv.className = 'result success';
                resultDiv.textContent = `Scene 1 State Changes:\n${JSON.stringify(scene1.data.contextOut.stateChanges, null, 2)}\n\n` +
                                     `Scene 2 State Changes:\n${JSON.stringify(scene2.data.contextOut.stateChanges, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function generateSceneDetail(request) {
            const response = await fetch(`${API_BASE}/generate_detail`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            });

            return await response.json();
        }

        function createEmptyContext() {
            return {
                keyEvents: [],
                revealedInfo: [],
                stateChanges: {},
                npcRelationships: {},
                environmentalState: {},
                plotThreads: [],
                playerDecisions: []
            };
        }

        function createEffectiveContext(previousScenes) {
            const effectiveContext = createEmptyContext();

            previousScenes.forEach(scene => {
                if (scene.contextOut) {
                    if (scene.contextOut.keyEvents) {
                        effectiveContext.keyEvents.push(...scene.contextOut.keyEvents);
                    }
                    if (scene.contextOut.revealedInfo) {
                        effectiveContext.revealedInfo.push(...scene.contextOut.revealedInfo);
                    }
                    if (scene.contextOut.stateChanges) {
                        Object.assign(effectiveContext.stateChanges, scene.contextOut.stateChanges);
                    }
                    if (scene.contextOut.npcRelationships) {
                        Object.assign(effectiveContext.npcRelationships, scene.contextOut.npcRelationships);
                    }
                    if (scene.contextOut.environmentalState) {
                        Object.assign(effectiveContext.environmentalState, scene.contextOut.environmentalState);
                    }
                    if (scene.contextOut.plotThreads) {
                        effectiveContext.plotThreads.push(...scene.contextOut.plotThreads);
                    }
                    if (scene.contextOut.playerDecisions) {
                        effectiveContext.playerDecisions.push(...scene.contextOut.playerDecisions);
                    }
                }
            });

            return effectiveContext;
        }
    </script>
</body>
</html>
