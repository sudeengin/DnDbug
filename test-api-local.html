<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macro Chain API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        
            padding-bottom: 420px; /* Make room for log viewer */}
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
    </style>
    
    <!-- Visual Log Viewer -->
    <script src="log-viewer.js"></script>

</head>
<body>
    <div class="container">
        <h1>Macro Chain API Test</h1>
        <p>Test the Macro Chain API endpoints locally.</p>
        
        <div>
            <button onclick="testGenerateChain()" id="generateBtn">Test Generate Chain</button>
            <button onclick="testUpdateChain()" id="updateBtn" disabled>Test Update Chain</button>
            <button onclick="testAddScene()" id="addSceneBtn" disabled>Test Add Scene</button>
            <button onclick="testDeleteScene()" id="deleteSceneBtn" disabled>Test Delete Scene</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        let currentChainId = null;

        async function testGenerateChain() {
            const generateBtn = document.getElementById('generateBtn');
            const resultDiv = document.getElementById('result');
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'Testing...';
            resultDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/generate_chain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        concept: 'A mysterious forest where ancient trees whisper secrets to those who listen carefully',
                        meta: {
                            gameType: 'one-shot',
                            players: '3-4 players',
                            level: 'beginner'
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.ok) {
                    currentChainId = data.data.chainId;
                    document.getElementById('updateBtn').disabled = false;
                    document.getElementById('addSceneBtn').disabled = false;
                    document.getElementById('deleteSceneBtn').disabled = false;
                    
                    let resultText = '✅ Generate Chain API Success!\n\n';
                    resultText += `Chain ID: ${data.data.chainId}\n`;
                    resultText += `Scenes: ${data.data.scenes.length}\n\n`;
                    
                    data.data.scenes.forEach((scene, index) => {
                        resultText += `Scene ${index + 1}: ${scene.title}\n`;
                        resultText += `  Objective: ${scene.objective}\n`;
                        resultText += `  ID: ${scene.id}\n\n`;
                    });
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = resultText;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Generate Chain API Error: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Test Generate Chain';
                resultDiv.style.display = 'block';
            }
        }

        async function testUpdateChain() {
            if (!currentChainId) {
                alert('Please test Generate Chain first');
                return;
            }

            const updateBtn = document.getElementById('updateBtn');
            const resultDiv = document.getElementById('result');
            
            updateBtn.disabled = true;
            updateBtn.textContent = 'Testing...';
            
            try {
                const response = await fetch('/api/update_chain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chainId: currentChainId,
                        edits: [{
                            type: 'edit_title',
                            sceneId: 'test_scene_1',
                            newValue: 'Updated Scene Title'
                        }]
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✅ Update Chain API Success!\n\n' + JSON.stringify(data, null, 2);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Update Chain API Error: ${error.message}`;
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Test Update Chain';
            }
        }

        async function testAddScene() {
            if (!currentChainId) {
                alert('Please test Generate Chain first');
                return;
            }

            const addSceneBtn = document.getElementById('addSceneBtn');
            const resultDiv = document.getElementById('result');
            
            addSceneBtn.disabled = true;
            addSceneBtn.textContent = 'Testing...';
            
            try {
                const newScene = {
                    id: `test-scene-${Date.now()}`,
                    order: 999,
                    title: 'Test New Scene',
                    objective: 'This is a test scene added via API'
                };

                const response = await fetch('/api/update_chain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chainId: currentChainId,
                        edits: [{
                            type: 'add_scene',
                            sceneData: newScene
                        }]
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✅ Add Scene API Success!\n\n' + JSON.stringify(data, null, 2);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Add Scene API Error: ${error.message}`;
            } finally {
                addSceneBtn.disabled = false;
                addSceneBtn.textContent = 'Test Add Scene';
            }
        }

        async function testDeleteScene() {
            if (!currentChainId) {
                alert('Please test Generate Chain first');
                return;
            }

            const deleteSceneBtn = document.getElementById('deleteSceneBtn');
            const resultDiv = document.getElementById('result');
            
            deleteSceneBtn.disabled = true;
            deleteSceneBtn.textContent = 'Testing...';
            
            try {
                const response = await fetch('/api/update_chain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chainId: currentChainId,
                        edits: [{
                            type: 'delete_scene',
                            sceneId: 'test_scene_1' // This would be a real scene ID in practice
                        }]
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✅ Delete Scene API Success!\n\n' + JSON.stringify(data, null, 2);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Delete Scene API Error: ${error.message}`;
            } finally {
                deleteSceneBtn.disabled = false;
                deleteSceneBtn.textContent = 'Test Delete Scene';
            }
        }

        function clearResults() {
            document.getElementById('result').style.display = 'none';
            currentChainId = null;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('addSceneBtn').disabled = true;
            document.getElementById('deleteSceneBtn').disabled = true;
        }
    </script>
</body>
</html>
