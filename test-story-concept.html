<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Concept Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        
            padding-bottom: 420px; /* Make room for log viewer */}
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .context-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
    
    <!-- Visual Log Viewer -->
    <script src="log-viewer.js"></script>

</head>
<body>
    <h1>Story Concept Storage & Lock Test</h1>
    <p>This page tests the story concept storage and locking functionality.</p>

    <div class="container">
        <h2>Test Configuration</h2>
        <div class="test-section">
            <label>Session ID: <input type="text" id="sessionId" value="test_story_concept_123"></label>
            <button onclick="generateSessionId()">Generate New Session</button>
        </div>
    </div>

    <div class="container">
        <h2>1. Story Concept Tests</h2>
        
        <div class="test-section">
            <h3>Add Story Concept</h3>
            <label>Story Concept: <textarea id="story-concept" placeholder="A group of adventurers investigates strange disappearances in a haunted mansion"></textarea></label>
            <label>Game Type: <select id="game-type">
                <option value="">Select...</option>
                <option value="D&D 5e">D&D 5e</option>
                <option value="Pathfinder">Pathfinder</option>
                <option value="Call of Cthulhu">Call of Cthulhu</option>
            </select></label>
            <label>Player Count: <input type="number" id="player-count" placeholder="4"></label>
            <label>Level: <input type="text" id="level" placeholder="e.g., 3-5"></label>
            <button onclick="addStoryConcept()">Add Story Concept</button>
            <div id="concept-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Lock/Unlock Story Concept</h3>
            <button onclick="lockStoryConcept(true)">Lock Story Concept</button>
            <button onclick="lockStoryConcept(false)">Unlock Story Concept</button>
            <div id="lock-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Context Operations</h3>
            <button onclick="getContext()">Get Current Context</button>
            <button onclick="clearContext()">Clear Context</button>
            <div id="context-result" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>2. Context Display</h2>
        <div id="context-display" class="context-display">
            <p>No context loaded yet. Add a story concept above.</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentContext = null;

        function generateSessionId() {
            const sessionId = `test_story_concept_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
            document.getElementById('sessionId').value = sessionId;
        }

        function getSessionId() {
            return document.getElementById('sessionId').value;
        }

        async function makeRequest(url, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(url, options);
                const result = await response.json();
                return { success: true, data: result };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function addStoryConcept() {
            const sessionId = getSessionId();
            const concept = document.getElementById('story-concept').value;
            const meta = {
                gameType: document.getElementById('game-type').value,
                players: document.getElementById('player-count').value,
                level: document.getElementById('level').value
            };

            // Filter out empty values
            const filteredMeta = Object.fromEntries(
                Object.entries(meta).filter(([_, value]) => value && value.trim() !== '')
            );

            const data = {
                concept: concept.trim(),
                meta: Object.keys(filteredMeta).length > 0 ? filteredMeta : undefined,
                timestamp: new Date().toISOString()
            };

            const result = await makeRequest(`${API_BASE}/context/append`, 'POST', {
                sessionId,
                blockType: 'story_concept',
                data
            });

            document.getElementById('concept-result').textContent = 
                result.success ? JSON.stringify(result.data, null, 2) : `Error: ${result.error}`;
            
            if (result.success) {
                currentContext = result.data.data;
                updateContextDisplay();
            }
        }

        async function lockStoryConcept(locked) {
            const sessionId = getSessionId();

            const result = await makeRequest(`${API_BASE}/context/lock`, 'PATCH', {
                sessionId,
                blockType: 'story_concept',
                locked
            });

            document.getElementById('lock-result').textContent = 
                result.success ? JSON.stringify(result.data, null, 2) : `Error: ${result.error}`;
            
            if (result.success) {
                currentContext = result.data.data;
                updateContextDisplay();
            }
        }

        async function getContext() {
            const sessionId = getSessionId();
            const result = await makeRequest(`${API_BASE}/context/get?sessionId=${sessionId}`);

            document.getElementById('context-result').textContent = 
                result.success ? JSON.stringify(result.data, null, 2) : `Error: ${result.error}`;
            
            if (result.success && result.data.data) {
                currentContext = result.data.data;
                updateContextDisplay();
            }
        }

        async function clearContext() {
            const sessionId = getSessionId();
            const result = await makeRequest(`${API_BASE}/context/clear`, 'POST', { sessionId });

            document.getElementById('context-result').textContent = 
                result.success ? 'Context cleared successfully' : `Error: ${result.error}`;
            
            if (result.success) {
                currentContext = null;
                updateContextDisplay();
            }
        }

        function updateContextDisplay() {
            const display = document.getElementById('context-display');
            
            if (!currentContext) {
                display.innerHTML = '<p>No context loaded yet. Add a story concept above.</p>';
                return;
            }

            let html = '<h3>Current Context</h3>';
            
            if (currentContext.blocks.story_concept) {
                const concept = currentContext.blocks.story_concept;
                const isLocked = currentContext.locks?.story_concept || false;
                
                html += '<div style="background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 4px;">';
                html += '<strong>Story Concept:</strong><br>';
                html += `Concept: ${concept.concept}<br>`;
                if (concept.meta) {
                    html += 'Meta Information:<br>';
                    if (concept.meta.gameType) html += `Game Type: ${concept.meta.gameType}<br>`;
                    if (concept.meta.players) html += `Players: ${concept.meta.players}<br>`;
                    if (concept.meta.level) html += `Level: ${concept.meta.level}<br>`;
                }
                html += `Created: ${new Date(concept.timestamp).toLocaleString()}<br>`;
                html += `Status: ${isLocked ? 'ðŸ”’ Locked' : 'ðŸ”“ Unlocked'}<br>`;
                html += '</div>';
            }

            html += `<p><small>Version: ${currentContext.version} | Updated: ${new Date(currentContext.updatedAt).toLocaleString()}</small></p>`;
            
            display.innerHTML = html;
        }

        // Initialize
        generateSessionId();
    </script>
</body>
</html>
